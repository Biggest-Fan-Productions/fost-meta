#!/usr/bin/env bash
cd $(dirname $0)
set -ex

TAG=$(git describe --dirty)
UBUNTU=bionic


function dockerize {
    sudo docker build --no-cache \
        --build-arg TAG=$TAG \
        --build-arg UBUNTU=$UBUNTU \
    sudo docker push fost/$1:$TAG
        --tag fost/$1:$TAG \
        --file $1.dockerfile .
}
function latest {
    sudo docker tag fost/$1:$TAG fost/$1:latest
    sudo docker push fost/$1:latest
}


sudo docker pull ubuntu:$UBUNTU
dockerize ubuntu; latest ubuntu
dockerize builder; latest builder
dockerize runtime; latest runtime

sudo docker build --no-cache \
        --build-arg TAG=$TAG \
        --tag fost/all:$TAG ..
sudo docker push fost/all:$TAG
        --file all.dockerfile \

if git branch | grep "* master" > /dev/null
then {
    latest all
}
fi
